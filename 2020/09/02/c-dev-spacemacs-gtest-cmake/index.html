<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C++ Spacemacs Development Environment (with CMake and gtest) | Matt Austin</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="
I've been switching most of my development activities over to Spacemacs for the last year or so.  Spacemacs is a preconfigured emacs distribution with convenient 'layers ...">
    <link rel="preload" href="/assets/css/0.styles.ef48967c.css" as="style"><link rel="preload" href="/assets/js/app.719779a0.js" as="script"><link rel="preload" href="/assets/js/6.5a5d3722.js" as="script"><link rel="preload" href="/assets/js/3.0200f067.js" as="script"><link rel="preload" href="/assets/js/17.5bee3966.js" as="script"><link rel="prefetch" href="/assets/js/10.ad42f919.js"><link rel="prefetch" href="/assets/js/11.5f2113f1.js"><link rel="prefetch" href="/assets/js/12.cbe1e5dd.js"><link rel="prefetch" href="/assets/js/13.71ad5dd4.js"><link rel="prefetch" href="/assets/js/14.1d0ed4df.js"><link rel="prefetch" href="/assets/js/15.46172771.js"><link rel="prefetch" href="/assets/js/16.b495c123.js"><link rel="prefetch" href="/assets/js/18.bb37b752.js"><link rel="prefetch" href="/assets/js/4.1e0a0c14.js"><link rel="prefetch" href="/assets/js/5.dfc964d0.js"><link rel="prefetch" href="/assets/js/7.a11674cb.js"><link rel="prefetch" href="/assets/js/8.bd5481f9.js"><link rel="prefetch" href="/assets/js/9.076c7963.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.fd7b906a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef48967c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Matt Austin </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Matt Austin </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        C++ Spacemacs Development Environment (with CMake and gtest)
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">mlaustin</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-09-03T00:00:00.000Z">
      Wed Sep 02 2020
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/c++" data-v-42ccfcd5><span data-v-42ccfcd5>c++</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/cmake" data-v-42ccfcd5><span data-v-42ccfcd5>cmake</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/environment" data-v-42ccfcd5><span data-v-42ccfcd5>environment</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/spacemacs" data-v-42ccfcd5><span data-v-42ccfcd5>spacemacs</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/emacs" data-v-42ccfcd5><span data-v-42ccfcd5>emacs</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>I've been switching most of my development activities over to <a href="https://www.spacemacs.org/" target="_blank" rel="noopener noreferrer">Spacemacs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the last year or so.  Spacemacs is a preconfigured emacs distribution with convenient 'layers' for languages and functionality which combine multiple emacs packages and configure them to work together.  It also uses the best vim emulation mode I've ever used, and has a &quot;leader&quot; key which brings up a branching menu to get to all the options and functions - the space bar (hence the name).  Spacemacs is the tool I use when I'm going to be doing serious development work; for quick edits and config files or scripts I use Vim, and for reading existing codebases I use VSCode.</p> <p>Spacemacs can provide what I consider a near-perfect C++ development experience, but the configuration to get there isn't completely clear, intuitive, or documented in a single location. I spent a day getting everything set up the way I wanted it for a recent project and wanted to document the process.  My project used what I would consider a very standard C++ toolchain:</p> <ul><li>C++17</li> <li>CMake for build and test automation</li> <li>Googletest (gtest) for testing and mocking</li></ul> <p>This is all based on a MacOS environment (Macbook Pro running Catalina), but I'll try to put in notes for setup on linux as well.  I'm pretty sure you can replicate this setup on Windows but I have 0 experience using emacs there.  If I worked in Windows I would use <a href="https://docs.microsoft.com/en-us/cpp/build/cmake-projects-in-visual-studio?view=vs-2019" target="_blank" rel="noopener noreferrer">Visual Studio with CMake<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> instead.  IMHO, it's genuinely hard to beat VS on Windows.</p> <h2 id="what-you-get"><a href="#what-you-get" class="header-anchor">#</a> What you get</h2> <ul><li>Code completion and definitions/info</li> <li>Syntax checking</li> <li>Build integration:
<ul><li>Automatic CMake execution to update compile commands</li> <li>Quick shortcuts to do 'cmake build' and 'make' with any target</li></ul></li> <li>Unit test integration, runner, and reporting using ctest to execute gtest test cases</li> <li>Easy project navigation</li></ul> <h2 id="pre-requisites"><a href="#pre-requisites" class="header-anchor">#</a> Pre-requisites</h2> <p>Assuming that you already have cmake, make, and your compiler of choice setup, this setup relies on a few other external tools which need to be installed first:</p> <h3 id="clangd"><a href="#clangd" class="header-anchor">#</a> clangd</h3> <p>clangd runs in the background as a language server, evaluating your source files and generating autocompletion suggestions and syntax checking.  <a href="https://clangd.llvm.org/installation.html" target="_blank" rel="noopener noreferrer">Installation instructions are at llvm's page<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="cmake-lsp-server"><a href="#cmake-lsp-server" class="header-anchor">#</a> CMake LSP Server</h3> <p>A language server backend for CMake.  It's a python package, so you can install with <code>pip install cmake-language-server</code>.  <a href="https://github.com/regen100/cmake-language-server" target="_blank" rel="noopener noreferrer">Details here.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="spacemacs-setup"><a href="#spacemacs-setup" class="header-anchor">#</a> Spacemacs Setup</h2> <h3 id="develop-branch"><a href="#develop-branch" class="header-anchor">#</a> Develop Branch</h3> <p>This is all based on the develop branch of Spacemacs.  If you're not familiar with this, the Spacemacs master branch is very rarely merged to, so the develop branch represents a stable branch which is a few thousand commits ahead.  There isn't a good reason not to use it at this point.  Since installing Spacemacs is just cloning their repo to your ~/.emacs.d, all you need to do is go there and <code>git checkout develop</code>.</p> <h3 id="layers"><a href="#layers" class="header-anchor">#</a> Layers</h3> <p>We need a few layers configured in the .spacemacs file (~/.spacemacs), or Spc-f-e-d to edit in Spacemacs:</p> <div class="language-lisp extra-class"><pre class="language-lisp"><code>dotspacemacs-configuration-layers
<span class="token punctuation">'(</span>
	auto-completion
	<span class="token punctuation">(</span><span class="token car">c-c++</span> <span class="token lisp-property property">:variables</span>
		c-c++-enable-clang-support <span class="token boolean">t</span>
		c-c++-backend <span class="token quoted-symbol variable symbol">'lsp-clangd</span><span class="token punctuation">)</span>
	<span class="token punctuation">(</span><span class="token car">cmake</span> <span class="token lisp-property property">:variables</span>
		cmake-enable-cmake-ide-support <span class="token boolean">t</span>
		cmake-backend <span class="token quoted-symbol variable symbol">'lsp</span><span class="token punctuation">)</span>
	lsp
	syntax-checking<span class="token punctuation">)</span>
</code></pre></div><p>Note: you're going to want more layers than just these!  This list is edited down from my actual config to contain just the layers needed for this C++ setup.</p> <p>auto-completion and syntax-checking are self explanatory.  lsp is required to allow emacs to communicate with the external language servers for clangd and CMake.  c-c++ and cmake layers need to have the backend set to the appropriate language server.  We also enable clang support for the c-c++ layer, which tells it to use clangd, and cmake-ide-support for CMake, which is needed to enable the CMake integration into emacs.</p> <p><a href="https://develop.spacemacs.org/layers/+tools/cmake/README.html" target="_blank" rel="noopener noreferrer">CMake layer docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://develop.spacemacs.org/layers/+lang/c-c++/README.html" target="_blank" rel="noopener noreferrer">C-C++ layer docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="clangd-location"><a href="#clangd-location" class="header-anchor">#</a> clangd location</h3> <p>On my mac, clangd didn't install a directory on the path (it went for /usr/local/opt/llvm/bin).  I added it to the path in both my ~/.zshrc and my ~/.bashrc but emacs still didn't want to recognize it.  You can manually set the location in the user-config section of your .spacemacs:</p> <div class="language-lisp extra-class"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">dotspacemacs/user-config</span> <span class="token punctuation">(</span><span class="token arguments"></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token keyword">setq</span> lsp-clients-clangd-executable <span class="token string">&quot;/usr/local/opt/llvm/bin/clangd&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><h2 id="project-setup-cmake-and-gtest"><a href="#project-setup-cmake-and-gtest" class="header-anchor">#</a> Project Setup (CMake and gtest)</h2> <p>My CMake project is standard CMake.  For configuring gtest, I used two resources:</p> <ul><li><a href="https://github.com/google/googletest/blob/master/googletest/README.md" target="_blank" rel="noopener noreferrer">Google's README<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://cliutils.gitlab.io/modern-cmake/chapters/testing/googletest.html" target="_blank" rel="noopener noreferrer">GoogleTest section of Modern CMake book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>The way I have my project set up is:</p> <ul><li>My 'overall' project is in ~/stuff/.  This is a sort of monorepo that holds a few components of a solution.</li> <li>My C++ project is in ~/stuff/my_project</li> <li>I have a main CMakeLists.txt located at ~/stuff/my_project/CMakeLists.txt</li> <li>My tests live in ~/stuff/my_project/tests/</li> <li>I have a secondary CMakeLists.txt in the tests folder which is responsible for building the tests</li></ul> <p>I wanted to pull the latest googletest dependencies at build time, so I actually have a secondary CMakeLists in my test folder (called CMakeLists.txt.in).  This sounds worse than it is:</p> <div class="language- extra-class"><pre class="language-text"><code>.
├── CMakeLists.txt
├── src
└── tests
    ├── CMakeLists.txt			
    ├── CMakeLists.txt.in
    ├── TestThing1.cpp
    └── TestThing2.cpp
</code></pre></div><h3 id="tests-cmakelists-txt-in"><a href="#tests-cmakelists-txt-in" class="header-anchor">#</a> tests/CMakeLists.txt.in</h3> <p>The tests/CMakeLists.txt.in is lifted straight from the googletest readme:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment">#seperate cmake project to download and install gtest at compile time</span>

<span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">2.8.2</span><span class="token punctuation">)</span>

<span class="token keyword">project</span><span class="token punctuation">(</span>googletest-download NONE<span class="token punctuation">)</span>

<span class="token keyword">include</span><span class="token punctuation">(</span>ExternalProject<span class="token punctuation">)</span>
<span class="token function">ExternalProject_Add</span><span class="token punctuation">(</span>googletest
  GIT_REPOSITORY    https://github.com/google/googletest.git
  GIT_TAG           master
  <span class="token property">SOURCE_DIR</span>        <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/googletest-src&quot;</span>
  <span class="token property">BINARY_DIR</span>        <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span></span>/googletest-build&quot;</span>
  CONFIGURE_COMMAND <span class="token string">&quot;&quot;</span>
  BUILD_COMMAND     <span class="token string">&quot;&quot;</span>
  INSTALL_COMMAND   <span class="token string">&quot;&quot;</span>
  TEST_COMMAND      <span class="token string">&quot;&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Fairly straightforward CMake - defines a new project and then uses ExternalProject_Add to pull the source from from github.</p> <h3 id="tests-cmakelists-txt"><a href="#tests-cmakelists-txt" class="header-anchor">#</a> tests/CMakeLists.txt</h3> <p>This one has 3 sections:</p> <ol><li>Configure and build googletest</li> <li>Define a macro to add googletest-based tests</li> <li>Add project tests</li></ol> <h4 id="configure-and-build-googletest"><a href="#configure-and-build-googletest" class="header-anchor">#</a> Configure and build googletest</h4> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># download and install gtest at compile time by creating a subproject</span>
<span class="token keyword">configure_file</span><span class="token punctuation">(</span>CMakeLists.txt.in googletest-download/CMakeLists.txt<span class="token punctuation">)</span>
<span class="token keyword">execute_process</span><span class="token punctuation">(</span>COMMAND <span class="token punctuation">${</span><span class="token variable">CMAKE_COMMAND</span><span class="token punctuation">}</span> -G <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_GENERATOR</span><span class="token punctuation">}</span></span>&quot;</span> .
  RESULT_VARIABLE result
  <span class="token property">WORKING_DIRECTORY</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/googletest-download <span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token keyword">message</span><span class="token punctuation">(</span>FATAL_ERROR <span class="token string">&quot;CMake step for googletest failed: <span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">result</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">execute_process</span><span class="token punctuation">(</span>COMMAND <span class="token punctuation">${</span><span class="token variable">CMAKE_COMMAND</span><span class="token punctuation">}</span> --build .
  RESULT_VARIABLE result
  <span class="token property">WORKING_DIRECTORY</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/googletest-download <span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token keyword">message</span><span class="token punctuation">(</span>FATAL_ERROR <span class="token string">&quot;Build step for googletest failed: <span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">result</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span><span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/googletest-src
                 <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_BINARY_DIR</span><span class="token punctuation">}</span>/googletest-build
                 <span class="token property">EXCLUDE_FROM_ALL</span><span class="token punctuation">)</span>
</code></pre></div><p>This is straight from the googletest readme - it adds the CMakelists.txt.in and runs it (which downloads the googletest repo), then it executes a <code>cmake --build</code> in the dowloaded googletest source folder to build the googletest components.</p> <h4 id="define-a-macro-to-add-gtest-tests"><a href="#define-a-macro-to-add-gtest-tests" class="header-anchor">#</a> Define a macro to add gtest tests</h4> <p>This is adapted from the Modern CMake book I linked above:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">macro</span><span class="token punctuation">(</span>package_add_test TESTNAME<span class="token punctuation">)</span>
  <span class="token keyword">add_executable</span><span class="token punctuation">(</span><span class="token punctuation">${</span>TESTNAME<span class="token punctuation">}</span> <span class="token punctuation">${</span>ARGN<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span><span class="token punctuation">${</span>TESTNAME<span class="token punctuation">}</span> gtest gmock gtest_main<span class="token punctuation">)</span>
  <span class="token function">gtest_discover_tests</span><span class="token punctuation">(</span><span class="token punctuation">${</span>TESTNAME<span class="token punctuation">}</span>
    <span class="token comment"># set a working directory so your project root so that you can find test data via paths relative to the project root</span>
    <span class="token property">WORKING_DIRECTORY</span> <span class="token punctuation">${</span>PROJECT_DIR<span class="token punctuation">}</span>
    <span class="token namespace">PROPERTIES</span> <span class="token property">VS_DEBUGGER_WORKING_DIRECTORY</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_DIR</span><span class="token punctuation">}</span></span>&quot;</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">set_target_properties</span><span class="token punctuation">(</span><span class="token punctuation">${</span>TESTNAME<span class="token punctuation">}</span> <span class="token namespace">PROPERTIES</span> <span class="token property">FOLDER</span> tests<span class="token punctuation">)</span>
<span class="token keyword">endmacro</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>The macro just writes the boilerplate code we'd otherwise need per test and sets up the directories correctly.  There have been a bunch of iterations within CMake for how to add test cases (and have them recognized as test cases for ctest), but since 3.10 <a href="https://cmake.org/cmake/help/v3.10/module/GoogleTest.html" target="_blank" rel="noopener noreferrer">gtest_discover_tests replaced gtest_add_tests<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h4 id="add-project-tests"><a href="#add-project-tests" class="header-anchor">#</a> Add project tests</h4> <p>Using the macro, this is really simple:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token comment"># Tests</span>
<span class="token function">package_add_test</span><span class="token punctuation">(</span>TEST_thing1 TestThing1.cpp ../src/thing1.cpp<span class="token punctuation">)</span>

<span class="token function">package_add_test</span><span class="token punctuation">(</span>TEST_thing2 TestThing2.cpp ../src/thing2.cpp<span class="token punctuation">)</span>
<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>TEST_thing2 thing3<span class="token punctuation">)</span>
</code></pre></div><p>With my directory structure, this CMake operation is running inside the tests folder - so test source files are local and source files require going up one level with .. to find the src folder.  You could of course just add all of the dependencies as arguments in the call to package_add_test(), but it makes more sense to link in anything that you've already built as a library using target_link_libraries().</p> <h3 id="cmaketests-txt"><a href="#cmaketests-txt" class="header-anchor">#</a> CMakeTests.txt</h3> <p>The main CMakeLists.txt file to tie everything together:</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.5</span><span class="token punctuation">)</span>
<span class="token keyword">project</span> <span class="token punctuation">(</span>my_project<span class="token punctuation">)</span>
<span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_STANDARD</span> <span class="token number">17</span><span class="token punctuation">)</span>

<span class="token comment">#TESTS</span>
<span class="token keyword">option</span><span class="token punctuation">(</span>BUILD_TESTS <span class="token string">&quot;Build the tests&quot;</span> <span class="token boolean">ON</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>BUILD_TESTS<span class="token punctuation">)</span>
    <span class="token keyword">enable_testing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span>GoogleTest<span class="token punctuation">)</span>
    <span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>tests<span class="token punctuation">)</span>
<span class="token keyword">endif</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span class="token punctuation">${</span><span class="token variable">CMAKE_BINARY_DIR</span><span class="token punctuation">}</span>/bin<span class="token punctuation">)</span>

<span class="token comment">#PROJECT</span>
<span class="token keyword">add_library</span><span class="token punctuation">(</span>thing1 src/thing1.cpp<span class="token punctuation">)</span>

<span class="token keyword">add_library</span><span class="token punctuation">(</span>thing2 src/thing2.cpp<span class="token punctuation">)</span>
<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>thing2 thing3<span class="token punctuation">)</span>

<span class="token keyword">add_library</span><span class="token punctuation">(</span>thing3 src/thing3.cpp<span class="token punctuation">)</span>
</code></pre></div><p>Again, pretty standard CMake stuff.  We add an option for &quot;BUILD_TESTS&quot; so that we only build the tests when we want to.  When this is enabled, enable_testing() activates ctest, then include(GoogleTest) loads the <a href="https://cmake.org/cmake/help/v3.14/module/GoogleTest.html" target="_blank" rel="noopener noreferrer">GoogleTest module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and finally the 'tests' subdirectory is added, causing the tests/CMakeLists.txt to be run.</p> <h2 id="project-setup-emacs-specific"><a href="#project-setup-emacs-specific" class="header-anchor">#</a> Project Setup (emacs specific)</h2> <p>The last step of setup is to configure the various emacs tools to know where to look for things.  This took me the longest time to work out as the tools seem to be both extremely stupid and extremely particular about locations and values.  There aren't any smart defaults or clever logic here.</p> <h3 id="dir-locals-el"><a href="#dir-locals-el" class="header-anchor">#</a> .dir-locals.el</h3> <p>Emacs will use a file called <code>.dir-locals.el</code> in the root of a project and execute the code in that file when you work in the directory containing it.  You are supposed to define the code to run by the mode, but I have everything in dir-locals run for all modes, because the only variables I set are C-C++ specific.</p> <div class="language-lisp extra-class"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">nil</span> <span class="token punctuation">.</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">helm-make-build-dir</span> <span class="token punctuation">.</span> <span class="token string">&quot;my_project/build&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token car">cmake-ide-project-dir</span> <span class="token punctuation">.</span> <span class="token string">&quot;~/stuff/my_project&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token car">cmake-ide-build-dir</span> <span class="token punctuation">.</span> <span class="token string">&quot;~/stuff/my_project/build&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token car">cmake-ide-cmake-opts</span> <span class="token punctuation">.</span> <span class="token string">&quot;-DBUILD_TESTS=<span class="token argument">ON</span> -DCMAKE_BUILD_TYPE=Debug&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token car">helm-ctest-dir</span> <span class="token punctuation">.</span> <span class="token string">&quot;~/stuff/my_project/build/tests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Helm-make - which spacemacs uses to let you pick the build targets from a list when you run make - needs to know exactly where to find the Makefile. Helm-make wants <em>RELATIVE PATHS</em>.</p> <p>CMake-ide similarly needs to know the project directory (where the CMakeLists.txt lives) and the build directory (where the Makefile goes).  In contrast to helm-make, cmake-ide insists on <em>ABSOLUTE PATHS</em>.  Why do these tightly related tools both have undocumented behavior causing them to silently fail if you try to use the same path reference type?  As far as I can tell - because f*** you, that's why.</p> <p>Helm-ctest needs the directory where the test executables will be built to.  It wants absolute paths too...</p> <h3 id="compilation-database"><a href="#compilation-database" class="header-anchor">#</a> Compilation Database</h3> <p>One last important thing - clangd needs a compilation database of all the compiler flags you would pass it.  This is the only way to clangd to know where your various dependencies live.  I wish it could do, say, <code>find . -name dependency.h</code> in the project folder and then raise an error only if there's multiple copies, but C++ has never really placed much stock in <a href="https://en.wikipedia.org/wiki/Most_vexing_parse" target="_blank" rel="noopener noreferrer">straightforward behavior<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Cmake-ide will generate a file called 'compile_commands.json' in the build folder, which is the exact output you need.  You can get behavior on your own by setting <a href="https://cmake.org/cmake/help/v3.5/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html" target="_blank" rel="noopener noreferrer">CMAKE_EXPORT_COMPILE_COMMANDS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and then running CMake.  If you're not using CMake there's a <a href="https://github.com/xavierd/clang_complete/blob/master/bin/cc_args.py" target="_blank" rel="noopener noreferrer">handy script to generate these<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Remember what I said about stupid defaults?  I would guess that 95%+ of the world's CMake projects build into a directory called 'build'.  Since the only place CMake will ever put the compile_commands.json is in the build folder, you'd expect cmake-ide to look for it there, right?  Nope!  I couldn't find this documented anywhere, but through trial and error worked out that it needs to be <em>in the same directory as the main CMakeLists.txt</em>.  The best way to get it there is to use a link, since cmake-ide is going to be regenerating the compile_commands.json all the time in the background:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ln</span> -s build/compile_commands.json <span class="token builtin class-name">.</span>
</code></pre></div><p>At this point you should restart spacemacs (Spc-q-R) to make sure all the new packages get installed.</p> <h2 id="features-and-useful-commands"><a href="#features-and-useful-commands" class="header-anchor">#</a> Features and useful commands</h2> <p>If all the setup worked, you should get a bunch of features.  Some of the baked in stuff that should just appear:</p> <ul><li>Autocompletion</li> <li>Syntax checking</li> <li>'Intellisense' style info popups.  If those are blocking something you need to read, C-g will close them, and setting auto-completion-enable-help-tooltip to f will disable them (M-x set-variable to change it)</li></ul> <p>And some of the commands I've found useful (although I highly recommend investigating what's present as I'm only scratching the surface):</p> <ul><li>Spc-m-c-c to run <code>cmake build</code> in your build folder with the options you set up in the dir-locals.el file</li> <li>Spc-m-p-c to run cmake as part of cmake-ide (this will generate the compile_commands.json)</li> <li>Spc-c-c to run make in your build folder.  Spc-c-C will just run <code>make</code>, while Spc-c-c will pop up a helm buffer to select the target from a list</li> <li>Spc-m-p-t to run a test with ctest. helm-ctest will pop up in a mini-buffer and display a list of each individual tests to choose from.  (want to run all of the tests?  Spc-c-c to get the helm-make buffer up, then select 'test' as the target.  It will run all of the tests with the nice ctest runner and drop the resulting logs in ./testing)</li> <li>Spc-m-g- for basic IDE goto functions.  My most used one here is Spc-m-g-a to switch between headers and implementation files.</li> <li>Spc-m-G- for advanced IDE functions like &quot;find implementation&quot;, &quot;find definition&quot;, &quot;find all references&quot;, etc</li> <li>Spc-m-=-b to format the current buffer with the LSP (clangd in this configuration)</li> <li>Spc-m-=-o to organize imports</li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#introduction" title="Introduction">Introduction</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#what-you-get" title="What you get">What you get</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#pre-requisites" title="Pre-requisites">Pre-requisites</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#clangd" title="clangd">clangd</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cmake-lsp-server" title="CMake LSP Server">CMake LSP Server</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#spacemacs-setup" title="Spacemacs Setup">Spacemacs Setup</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#develop-branch" title="Develop Branch">Develop Branch</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#layers" title="Layers">Layers</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#clangd-location" title="clangd location">clangd location</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#project-setup-cmake-and-gtest" title="Project Setup (CMake and gtest)">Project Setup (CMake and gtest)</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#tests-cmakelists-txt-in" title="tests/CMakeLists.txt.in">tests/CMakeLists.txt.in</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#tests-cmakelists-txt" title="tests/CMakeLists.txt">tests/CMakeLists.txt</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cmaketests-txt" title="CMakeTests.txt">CMakeTests.txt</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#project-setup-emacs-specific" title="Project Setup (emacs specific)">Project Setup (emacs specific)</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#dir-locals-el" title=".dir-locals.el">.dir-locals.el</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#compilation-database" title="Compilation Database">Compilation Database</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#features-and-useful-commands" title="Features and useful commands">Features and useful commands</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/mlaustin44" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/2020/09/02/c-dev-spacemacs-gtest-cmake/.html" class="nav-link" data-v-fdbf4940>Matthew Austin © 2020</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.719779a0.js" defer></script><script src="/assets/js/6.5a5d3722.js" defer></script><script src="/assets/js/3.0200f067.js" defer></script><script src="/assets/js/17.5bee3966.js" defer></script>
  </body>
</html>
