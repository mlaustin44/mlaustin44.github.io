(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{391:function(t,e,s){"use strict";s.r(e);var a=s(10),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"introduction"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),s("p",[t._v("I've been switching most of my development activities over to "),s("a",{attrs:{href:"https://www.spacemacs.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Spacemacs"),s("OutboundLink")],1),t._v(" for the last year or so.  Spacemacs is a preconfigured emacs distribution with convenient 'layers' for languages and functionality which combine multiple emacs packages and configure them to work together.  It also uses the best vim emulation mode I've ever used, and has a \"leader\" key which brings up a branching menu to get to all the options and functions - the space bar (hence the name).  Spacemacs is the tool I use when I'm going to be doing serious development work; for quick edits and config files or scripts I use Vim, and for reading existing codebases I use VSCode.")]),t._v(" "),s("p",[t._v("Spacemacs can provide what I consider a near-perfect C++ development experience, but the configuration to get there isn't completely clear, intuitive, or documented in a single location. I spent a day getting everything set up the way I wanted it for a recent project and wanted to document the process.  My project used what I would consider a very standard C++ toolchain:")]),t._v(" "),s("ul",[s("li",[t._v("C++17")]),t._v(" "),s("li",[t._v("CMake for build and test automation")]),t._v(" "),s("li",[t._v("Googletest (gtest) for testing and mocking")])]),t._v(" "),s("p",[t._v("This is all based on a MacOS environment (Macbook Pro running Catalina), but I'll try to put in notes for setup on linux as well.  I'm pretty sure you can replicate this setup on Windows but I have 0 experience using emacs there.  If I worked in Windows I would use "),s("a",{attrs:{href:"https://docs.microsoft.com/en-us/cpp/build/cmake-projects-in-visual-studio?view=vs-2019",target:"_blank",rel:"noopener noreferrer"}},[t._v("Visual Studio with CMake"),s("OutboundLink")],1),t._v(" instead.  IMHO, it's genuinely hard to beat VS on Windows.")]),t._v(" "),s("h2",{attrs:{id:"what-you-get"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#what-you-get"}},[t._v("#")]),t._v(" What you get")]),t._v(" "),s("ul",[s("li",[t._v("Code completion and definitions/info")]),t._v(" "),s("li",[t._v("Syntax checking")]),t._v(" "),s("li",[t._v("Build integration:\n"),s("ul",[s("li",[t._v("Automatic CMake execution to update compile commands")]),t._v(" "),s("li",[t._v("Quick shortcuts to do 'cmake build' and 'make' with any target")])])]),t._v(" "),s("li",[t._v("Unit test integration, runner, and reporting using ctest to execute gtest test cases")]),t._v(" "),s("li",[t._v("Easy project navigation")])]),t._v(" "),s("h2",{attrs:{id:"pre-requisites"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisites"}},[t._v("#")]),t._v(" Pre-requisites")]),t._v(" "),s("p",[t._v("Assuming that you already have cmake, make, and your compiler of choice setup, this setup relies on a few other external tools which need to be installed first:")]),t._v(" "),s("h3",{attrs:{id:"clangd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#clangd"}},[t._v("#")]),t._v(" clangd")]),t._v(" "),s("p",[t._v("clangd runs in the background as a language server, evaluating your source files and generating autocompletion suggestions and syntax checking.  "),s("a",{attrs:{href:"https://clangd.llvm.org/installation.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Installation instructions are at llvm's page"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("h3",{attrs:{id:"cmake-lsp-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cmake-lsp-server"}},[t._v("#")]),t._v(" CMake LSP Server")]),t._v(" "),s("p",[t._v("A language server backend for CMake.  It's a python package, so you can install with "),s("code",[t._v("pip install cmake-language-server")]),t._v(".  "),s("a",{attrs:{href:"https://github.com/regen100/cmake-language-server",target:"_blank",rel:"noopener noreferrer"}},[t._v("Details here."),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"spacemacs-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spacemacs-setup"}},[t._v("#")]),t._v(" Spacemacs Setup")]),t._v(" "),s("h3",{attrs:{id:"develop-branch"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#develop-branch"}},[t._v("#")]),t._v(" Develop Branch")]),t._v(" "),s("p",[t._v("This is all based on the develop branch of Spacemacs.  If you're not familiar with this, the Spacemacs master branch is very rarely merged to, so the develop branch represents a stable branch which is a few thousand commits ahead.  There isn't a good reason not to use it at this point.  Since installing Spacemacs is just cloning their repo to your ~/.emacs.d, all you need to do is go there and "),s("code",[t._v("git checkout develop")]),t._v(".")]),t._v(" "),s("h3",{attrs:{id:"layers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#layers"}},[t._v("#")]),t._v(" Layers")]),t._v(" "),s("p",[t._v("We need a few layers configured in the .spacemacs file (~/.spacemacs), or Spc-f-e-d to edit in Spacemacs:")]),t._v(" "),s("div",{staticClass:"language-lisp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lisp"}},[s("code",[t._v("dotspacemacs-configuration-layers\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'(")]),t._v("\n\tauto-completion\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("c-c++")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token lisp-property property"}},[t._v(":variables")]),t._v("\n\t\tc-c++-enable-clang-support "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("t")]),t._v("\n\t\tc-c++-backend "),s("span",{pre:!0,attrs:{class:"token quoted-symbol variable symbol"}},[t._v("'lsp-clangd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("cmake")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token lisp-property property"}},[t._v(":variables")]),t._v("\n\t\tcmake-enable-cmake-ide-support "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("t")]),t._v("\n\t\tcmake-backend "),s("span",{pre:!0,attrs:{class:"token quoted-symbol variable symbol"}},[t._v("'lsp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tlsp\n\tsyntax-checking"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("Note: you're going to want more layers than just these!  This list is edited down from my actual config to contain just the layers needed for this C++ setup.")]),t._v(" "),s("p",[t._v("auto-completion and syntax-checking are self explanatory.  lsp is required to allow emacs to communicate with the external language servers for clangd and CMake.  c-c++ and cmake layers need to have the backend set to the appropriate language server.  We also enable clang support for the c-c++ layer, which tells it to use clangd, and cmake-ide-support for CMake, which is needed to enable the CMake integration into emacs.")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://develop.spacemacs.org/layers/+tools/cmake/README.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("CMake layer docs"),s("OutboundLink")],1),t._v(" "),s("a",{attrs:{href:"https://develop.spacemacs.org/layers/+lang/c-c++/README.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("C-C++ layer docs"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"clangd-location"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#clangd-location"}},[t._v("#")]),t._v(" clangd location")]),t._v(" "),s("p",[t._v("On my mac, clangd didn't install a directory on the path (it went for /usr/local/opt/llvm/bin).  I added it to the path in both my ~/.zshrc and my ~/.bashrc but emacs still didn't want to recognize it.  You can manually set the location in the user-config section of your .spacemacs:")]),t._v(" "),s("div",{staticClass:"language-lisp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lisp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token defun"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dotspacemacs/user-config")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token arguments"}}),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("setq")]),t._v(" lsp-clients-clangd-executable "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/local/opt/llvm/bin/clangd"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h2",{attrs:{id:"project-setup-cmake-and-gtest"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#project-setup-cmake-and-gtest"}},[t._v("#")]),t._v(" Project Setup (CMake and gtest)")]),t._v(" "),s("p",[t._v("My CMake project is standard CMake.  For configuring gtest, I used two resources:")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/google/googletest/blob/master/googletest/README.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google's README"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://cliutils.gitlab.io/modern-cmake/chapters/testing/googletest.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("GoogleTest section of Modern CMake book"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("The way I have my project set up is:")]),t._v(" "),s("ul",[s("li",[t._v("My 'overall' project is in ~/stuff/.  This is a sort of monorepo that holds a few components of a solution.")]),t._v(" "),s("li",[t._v("My C++ project is in ~/stuff/my_project")]),t._v(" "),s("li",[t._v("I have a main CMakeLists.txt located at ~/stuff/my_project/CMakeLists.txt")]),t._v(" "),s("li",[t._v("My tests live in ~/stuff/my_project/tests/")]),t._v(" "),s("li",[t._v("I have a secondary CMakeLists.txt in the tests folder which is responsible for building the tests")])]),t._v(" "),s("p",[t._v("I wanted to pull the latest googletest dependencies at build time, so I actually have a secondary CMakeLists in my test folder (called CMakeLists.txt.in).  This sounds worse than it is:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v(".\n├── CMakeLists.txt\n├── src\n└── tests\n    ├── CMakeLists.txt\t\t\t\n    ├── CMakeLists.txt.in\n    ├── TestThing1.cpp\n    └── TestThing2.cpp\n")])])]),s("h3",{attrs:{id:"tests-cmakelists-txt-in"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tests-cmakelists-txt-in"}},[t._v("#")]),t._v(" tests/CMakeLists.txt.in")]),t._v(" "),s("p",[t._v("The tests/CMakeLists.txt.in is lifted straight from the googletest readme:")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#seperate cmake project to download and install gtest at compile time")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("cmake_minimum_required")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("VERSION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.8.2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("project")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("googletest-download NONE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ExternalProject"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ExternalProject_Add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("googletest\n  GIT_REPOSITORY    https://github.com/google/googletest.git\n  GIT_TAG           master\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("SOURCE_DIR")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('/googletest-src"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("BINARY_DIR")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('/googletest-build"')]),t._v("\n  CONFIGURE_COMMAND "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  BUILD_COMMAND     "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  INSTALL_COMMAND   "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  TEST_COMMAND      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("Fairly straightforward CMake - defines a new project and then uses ExternalProject_Add to pull the source from from github.")]),t._v(" "),s("h3",{attrs:{id:"tests-cmakelists-txt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tests-cmakelists-txt"}},[t._v("#")]),t._v(" tests/CMakeLists.txt")]),t._v(" "),s("p",[t._v("This one has 3 sections:")]),t._v(" "),s("ol",[s("li",[t._v("Configure and build googletest")]),t._v(" "),s("li",[t._v("Define a macro to add googletest-based tests")]),t._v(" "),s("li",[t._v("Add project tests")])]),t._v(" "),s("h4",{attrs:{id:"configure-and-build-googletest"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-and-build-googletest"}},[t._v("#")]),t._v(" Configure and build googletest")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# download and install gtest at compile time by creating a subproject")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("configure_file")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CMakeLists.txt.in googletest-download/CMakeLists.txt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("execute_process")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("COMMAND "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_COMMAND")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" -G "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_GENERATOR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v(" .\n  RESULT_VARIABLE result\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("WORKING_DIRECTORY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/googletest-download "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("message")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("FATAL_ERROR "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CMake step for googletest failed: '),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("result")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("endif")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("execute_process")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("COMMAND "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_COMMAND")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" --build .\n  RESULT_VARIABLE result\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("WORKING_DIRECTORY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/googletest-download "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("message")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("FATAL_ERROR "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Build step for googletest failed: '),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("result")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("endif")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_subdirectory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/googletest-src\n                 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CURRENT_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/googletest-build\n                 "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("EXCLUDE_FROM_ALL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("This is straight from the googletest readme - it adds the CMakelists.txt.in and runs it (which downloads the googletest repo), then it executes a "),s("code",[t._v("cmake --build")]),t._v(" in the dowloaded googletest source folder to build the googletest components.")]),t._v(" "),s("h4",{attrs:{id:"define-a-macro-to-add-gtest-tests"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#define-a-macro-to-add-gtest-tests"}},[t._v("#")]),t._v(" Define a macro to add gtest tests")]),t._v(" "),s("p",[t._v("This is adapted from the Modern CMake book I linked above:")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("macro")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("package_add_test TESTNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_executable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("TESTNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("ARGN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("target_link_libraries")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("TESTNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" gtest gmock gtest_main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gtest_discover_tests")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("TESTNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# set a working directory so your project root so that you can find test data via paths relative to the project root")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("WORKING_DIRECTORY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("PROJECT_DIR"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("PROPERTIES")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("VS_DEBUGGER_WORKING_DIRECTORY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("PROJECT_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set_target_properties")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),t._v("TESTNAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("PROPERTIES")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("FOLDER")]),t._v(" tests"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("endmacro")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("The macro just writes the boilerplate code we'd otherwise need per test and sets up the directories correctly.  There have been a bunch of iterations within CMake for how to add test cases (and have them recognized as test cases for ctest), but since 3.10 "),s("a",{attrs:{href:"https://cmake.org/cmake/help/v3.10/module/GoogleTest.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("gtest_discover_tests replaced gtest_add_tests"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("h4",{attrs:{id:"add-project-tests"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add-project-tests"}},[t._v("#")]),t._v(" Add project tests")]),t._v(" "),s("p",[t._v("Using the macro, this is really simple:")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Tests")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("package_add_test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TEST_thing1 TestThing1.cpp ../src/thing1.cpp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("package_add_test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TEST_thing2 TestThing2.cpp ../src/thing2.cpp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("target_link_libraries")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TEST_thing2 thing3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("With my directory structure, this CMake operation is running inside the tests folder - so test source files are local and source files require going up one level with .. to find the src folder.  You could of course just add all of the dependencies as arguments in the call to package_add_test(), but it makes more sense to link in anything that you've already built as a library using target_link_libraries().")]),t._v(" "),s("h3",{attrs:{id:"cmaketests-txt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cmaketests-txt"}},[t._v("#")]),t._v(" CMakeTests.txt")]),t._v(" "),s("p",[t._v("The main CMakeLists.txt file to tie everything together:")]),t._v(" "),s("div",{staticClass:"language-cmake extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cmake"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("cmake_minimum_required")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("VERSION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("project")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("my_project"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_CXX_STANDARD")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#TESTS")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("option")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BUILD_TESTS "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Build the tests"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("ON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BUILD_TESTS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enable_testing")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GoogleTest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_subdirectory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tests"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("endif")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_RUNTIME_OUTPUT_DIRECTORY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("CMAKE_BINARY_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/bin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#PROJECT")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_library")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thing1 src/thing1.cpp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_library")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thing2 src/thing2.cpp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("target_link_libraries")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thing2 thing3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_library")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("thing3 src/thing3.cpp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v('Again, pretty standard CMake stuff.  We add an option for "BUILD_TESTS" so that we only build the tests when we want to.  When this is enabled, enable_testing() activates ctest, then include(GoogleTest) loads the '),s("a",{attrs:{href:"https://cmake.org/cmake/help/v3.14/module/GoogleTest.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("GoogleTest module"),s("OutboundLink")],1),t._v(", and finally the 'tests' subdirectory is added, causing the tests/CMakeLists.txt to be run.")]),t._v(" "),s("h2",{attrs:{id:"project-setup-emacs-specific"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#project-setup-emacs-specific"}},[t._v("#")]),t._v(" Project Setup (emacs specific)")]),t._v(" "),s("p",[t._v("The last step of setup is to configure the various emacs tools to know where to look for things.  This took me the longest time to work out as the tools seem to be both extremely stupid and extremely particular about locations and values.  There aren't any smart defaults or clever logic here.")]),t._v(" "),s("h3",{attrs:{id:"dir-locals-el"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dir-locals-el"}},[t._v("#")]),t._v(" .dir-locals.el")]),t._v(" "),s("p",[t._v("Emacs will use a file called "),s("code",[t._v(".dir-locals.el")]),t._v(" in the root of a project and execute the code in that file when you work in the directory containing it.  You are supposed to define the code to run by the mode, but I have everything in dir-locals run for all modes, because the only variables I set are C-C++ specific.")]),t._v(" "),s("div",{staticClass:"language-lisp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lisp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("helm-make-build-dir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my_project/build"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("cmake-ide-project-dir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"~/stuff/my_project"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("cmake-ide-build-dir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"~/stuff/my_project/build"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("cmake-ide-cmake-opts")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-DBUILD_TESTS='),s("span",{pre:!0,attrs:{class:"token argument"}},[t._v("ON")]),t._v(' -DCMAKE_BUILD_TYPE=Debug"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token car"}},[t._v("helm-ctest-dir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"~/stuff/my_project/build/tests"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("Helm-make - which spacemacs uses to let you pick the build targets from a list when you run make - needs to know exactly where to find the Makefile. Helm-make wants "),s("em",[t._v("RELATIVE PATHS")]),t._v(".")]),t._v(" "),s("p",[t._v("CMake-ide similarly needs to know the project directory (where the CMakeLists.txt lives) and the build directory (where the Makefile goes).  In contrast to helm-make, cmake-ide insists on "),s("em",[t._v("ABSOLUTE PATHS")]),t._v(".  Why do these tightly related tools both have undocumented behavior causing them to silently fail if you try to use the same path reference type?  As far as I can tell - because f*** you, that's why.")]),t._v(" "),s("p",[t._v("Helm-ctest needs the directory where the test executables will be built to.  It wants absolute paths too...")]),t._v(" "),s("h3",{attrs:{id:"compilation-database"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#compilation-database"}},[t._v("#")]),t._v(" Compilation Database")]),t._v(" "),s("p",[t._v("One last important thing - clangd needs a compilation database of all the compiler flags you would pass it.  This is the only way to clangd to know where your various dependencies live.  I wish it could do, say, "),s("code",[t._v("find . -name dependency.h")]),t._v(" in the project folder and then raise an error only if there's multiple copies, but C++ has never really placed much stock in "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Most_vexing_parse",target:"_blank",rel:"noopener noreferrer"}},[t._v("straightforward behavior"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("Cmake-ide will generate a file called 'compile_commands.json' in the build folder, which is the exact output you need.  You can get behavior on your own by setting "),s("a",{attrs:{href:"https://cmake.org/cmake/help/v3.5/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("CMAKE_EXPORT_COMPILE_COMMANDS"),s("OutboundLink")],1),t._v(" and then running CMake.  If you're not using CMake there's a "),s("a",{attrs:{href:"https://github.com/xavierd/clang_complete/blob/master/bin/cc_args.py",target:"_blank",rel:"noopener noreferrer"}},[t._v("handy script to generate these"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("p",[t._v("Remember what I said about stupid defaults?  I would guess that 95%+ of the world's CMake projects build into a directory called 'build'.  Since the only place CMake will ever put the compile_commands.json is in the build folder, you'd expect cmake-ide to look for it there, right?  Nope!  I couldn't find this documented anywhere, but through trial and error worked out that it needs to be "),s("em",[t._v("in the same directory as the main CMakeLists.txt")]),t._v(".  The best way to get it there is to use a link, since cmake-ide is going to be regenerating the compile_commands.json all the time in the background:")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s build/compile_commands.json "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("At this point you should restart spacemacs (Spc-q-R) to make sure all the new packages get installed.")]),t._v(" "),s("h2",{attrs:{id:"features-and-useful-commands"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#features-and-useful-commands"}},[t._v("#")]),t._v(" Features and useful commands")]),t._v(" "),s("p",[t._v("If all the setup worked, you should get a bunch of features.  Some of the baked in stuff that should just appear:")]),t._v(" "),s("ul",[s("li",[t._v("Autocompletion")]),t._v(" "),s("li",[t._v("Syntax checking")]),t._v(" "),s("li",[t._v("'Intellisense' style info popups.  If those are blocking something you need to read, C-g will close them, and setting auto-completion-enable-help-tooltip to f will disable them (M-x set-variable to change it)")])]),t._v(" "),s("p",[t._v("And some of the commands I've found useful (although I highly recommend investigating what's present as I'm only scratching the surface):")]),t._v(" "),s("ul",[s("li",[t._v("Spc-m-c-c to run "),s("code",[t._v("cmake build")]),t._v(" in your build folder with the options you set up in the dir-locals.el file")]),t._v(" "),s("li",[t._v("Spc-m-p-c to run cmake as part of cmake-ide (this will generate the compile_commands.json)")]),t._v(" "),s("li",[t._v("Spc-c-c to run make in your build folder.  Spc-c-C will just run "),s("code",[t._v("make")]),t._v(", while Spc-c-c will pop up a helm buffer to select the target from a list")]),t._v(" "),s("li",[t._v("Spc-m-p-t to run a test with ctest. helm-ctest will pop up in a mini-buffer and display a list of each individual tests to choose from.  (want to run all of the tests?  Spc-c-c to get the helm-make buffer up, then select 'test' as the target.  It will run all of the tests with the nice ctest runner and drop the resulting logs in ./testing)")]),t._v(" "),s("li",[t._v("Spc-m-g- for basic IDE goto functions.  My most used one here is Spc-m-g-a to switch between headers and implementation files.")]),t._v(" "),s("li",[t._v('Spc-m-G- for advanced IDE functions like "find implementation", "find definition", "find all references", etc')]),t._v(" "),s("li",[t._v("Spc-m-=-b to format the current buffer with the LSP (clangd in this configuration)")]),t._v(" "),s("li",[t._v("Spc-m-=-o to organize imports")])])])}),[],!1,null,null,null);e.default=n.exports}}]);