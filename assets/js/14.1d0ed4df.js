(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{395:function(e,t,a){"use strict";a.r(t);var s=a(10),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("I bought a used enterprise server recently.  This post details what I bought, some rationale behind it, and the basic steps I used to set it up.")]),e._v(" "),a("h2",{attrs:{id:"server-requirements"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server-requirements"}},[e._v("#")]),e._v(" Server Requirements")]),e._v(" "),a("p",[e._v("Prior to purchasing the server, my basic requirements were:")]),e._v(" "),a("ul",[a("li",[e._v("Dual CPUs")]),e._v(" "),a("li",[e._v("LGA2011 or newer socket CPUs (for power consumption)")]),e._v(" "),a("li",[e._v(">100GB of RAM already installed")]),e._v(" "),a("li",[e._v(">4TB of HDD already installed")]),e._v(" "),a("li",[e._v("Some kind of "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Out-of-band_management",target:"_blank",rel:"noopener noreferrer"}},[e._v("lights-out KVM management"),a("OutboundLink")],1)])]),e._v(" "),a("p",[e._v("I wanted RAM and HDDs to be included because I didn't want to fall into the trap of needing to hunt down specific compatible parts, buying them, and then installing them.  I have a hard enough time finishing projects when everything is already in my favor and I didn't want to tempt fate by inviting in a month-long compatibility and server building exercise.")]),e._v(" "),a("h2",{attrs:{id:"planned-uses"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#planned-uses"}},[e._v("#")]),e._v(" Planned Uses")]),e._v(" "),a("p",[e._v("I'm planning to use the server for two basic things - self-hosting applications for my household, hosting development resources for myself, and general learning/education.")]),e._v(" "),a("p",[e._v("It's going to run Proxmox VE to virtualize both VMs and LXC containers.")]),e._v(" "),a("h2",{attrs:{id:"server-hardware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server-hardware"}},[e._v("#")]),e._v(" Server Hardware")]),e._v(" "),a("p",[e._v("I bought my server from eSISO, which is a very large used enterprise equiptment vendor.  I got an HP DL360p Gen8 server with these basic specs:")]),e._v(" "),a("ul",[a("li",[e._v("2x Xeon E5-2640 CPUs (6 cores each at 2.5GHz)")]),e._v(" "),a("li",[e._v("128GB DDR3 ECC RAM")]),e._v(" "),a("li",[e._v("4x2TB SAS HDDs")]),e._v(" "),a("li",[e._v("Redundant PSUs")])]),e._v(" "),a("h3",{attrs:{id:"dell-vs-hp-vs-others"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dell-vs-hp-vs-others"}},[e._v("#")]),e._v(" Dell vs HP vs Others")]),e._v(" "),a("p",[e._v("My sense is that for a home lab dell is probably the better manufacturer (fewer license restrictions, better hardware compatibility, slightly lower power consumption) but at the time I was looking HPs were about 10% cheaper.")]),e._v(" "),a("h3",{attrs:{id:"hp-server-details"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hp-server-details"}},[e._v("#")]),e._v(" HP Server Details")]),e._v(" "),a("p",[e._v("As far as I can determine, the two primary HP servers in the used market are the DL360p and the DL380p (there are "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/ProLiant#Density_Line_(DL)",target:"_blank",rel:"noopener noreferrer"}},[e._v("lots of others"),a("OutboundLink")],1),e._v(", but I only saw 360's and 380's commonly available - your mileage may vary).  The 360 is a 1u server and the 380 is a 2u.  I would have slightly preferred a 2u unit just for the extra drive bays, but I found a perfect deal on a 1u 360 unit.")]),e._v(" "),a("p",[e._v("I wanted a gen8 server (2012-2014) as they have newer LGA2011 socket CPUs which use quite a bit less power.")]),e._v(" "),a("h3",{attrs:{id:"power-consumption-and-noise"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#power-consumption-and-noise"}},[e._v("#")]),e._v(" Power Consumption and Noise")]),e._v(" "),a("p",[e._v("I don't think I've ever met a piece of enterprise hardware that doesn't sound and put off heat like a jet engine, to say nothing of the power consumption in a home environment.  I'm fortunate to have a basement for gear like this, but when I had the server running in my home office it was loud enough to hear from my driveway and cut right through noise cancelling headphones.  I wouldn't consider something like this unless I had an unoccupied room to stick it in.")]),e._v(" "),a("p",[e._v("I'm estimating that my server will consume around 100w at idle and 200+w at full load.  At my power prices ($0.12/kWh) it will cost me $8-10/month just to run the server full time.")]),e._v(" "),a("h2",{attrs:{id:"server-setup-and-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server-setup-and-configuration"}},[e._v("#")]),e._v(" Server Setup and Configuration")]),e._v(" "),a("h3",{attrs:{id:"storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#storage"}},[e._v("#")]),e._v(" Storage")]),e._v(" "),a("p",[e._v("I'm running Proxmox as my OS/Hypervisor and wanted the storage configured in "),a("a",{attrs:{href:"http://kbdone.com/zfs-basics/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ZFS"),a("OutboundLink")],1),e._v(" to provide software based disk management and RAID capabilities.  For ZFS to work correctly, the drives need to be directly available to the OS through HBA (host bus adapter) mode - no RAID, no controller caches, etc.")]),e._v(" "),a("p",[e._v("The controller which comes built into the server is a P420i, which is a traditional RAID controller.  It can "),a("em",[e._v("kinda")]),e._v(" do HBA, but if you configure it that way you can't boot from the drives (so you need an SD card to hold your /boot), and reports indicate it's slow.")]),e._v(" "),a("p",[e._v("So I bought an HBA card.  I wanted an officially supported HP card to avoid any strange behaivors (apparently HP servers will run the fans at 100% all the time if you install certain unsupported hardware).  "),a("a",{attrs:{href:"https://support.hpe.com/hpesc/public/docDisplay?docId=emr_na-c03244006#N11D46",target:"_blank",rel:"noopener noreferrer"}},[e._v("Three cards are officially supported"),a("OutboundLink")],1),e._v(" so naturally I went for the cheapest, the 'H220 Host Bus Adapter', part #650933-B21, which is available on eBay for ~$30 at the time of writing.")]),e._v(" "),a("p",[a("strong",[e._v("A quick aside -")]),e._v(" this isn't explained anywhere clearly, but the built in P420i controller is part of the motherboard in the server.  There is an expansion caddy thing that has two PCIe slots - 1 x8 and 1 x16.  The H220 is an x8 PCIe card.")]),e._v(" "),a("p",[e._v("If you're getting the H220 card, or any other PCIe storage controller, you will also need a new mini-SAS cable.  The one used to connect to the onboard controller has right angles at both ends (since the port on the motherboard is vertical) and is too short to reach the PCIe slot area.  You officially need a 'Straight SFF-8087 to Left Angle SFF-8087 Mini SAS Cable\" of about 0.75M length.  "),a("a",{attrs:{href:"https://www.amazon.com/gp/product/B01KFEVOPA/",target:"_blank",rel:"noopener noreferrer"}},[e._v("This cable"),a("OutboundLink")],1),e._v(" (CableCreation part #CS0113) does the job perfectly for $11 at time of writing.  There is an official HP version of this cable that appears to sell for $150.")]),e._v(" "),a("h3",{attrs:{id:"networking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#networking"}},[e._v("#")]),e._v(" Networking")]),e._v(" "),a("p",[e._v("There's an RJ45 port on the motherboard which is only for the iLO management interface.  My server came with a 4 port NIC.  You need to connect both the iLO port and the real ethernet port.")]),e._v(" "),a("h3",{attrs:{id:"using-ilo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-ilo"}},[e._v("#")]),e._v(" Using iLO")]),e._v(" "),a("p",[e._v("When the server boots it will get a DHCP address for the iLO interface.  You can visit this in a browser to get access to all the server information.  There is a .net and Java web based remote console, but I found nothing but frustration using them.  There's an "),a("a",{attrs:{href:"https://support.hpe.com/hpsc/swd/public/detail?swItemId=MTX_4f842ceb31cf48d392e22705a8",target:"_blank",rel:"noopener noreferrer"}},[e._v("HP IRC Desktop Client"),a("OutboundLink")],1),e._v(" that works "),a("em",[e._v("much")]),e._v(" better for remote KVM features.  My primary workstations are my work-issued 15\" Macbook, my desktop with Ubuntu and Windows 10 on dual boot, and a Lenovo laptop running Ubuntu. I didn't feel like rebooting my computer back and forth during the server setup, so I used the following Vagrant config to let me run the HP IRC client in a VM (I ran into repeated issues trying to get the WPF app to work in wine).")]),e._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[e._v("Vagrant")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("configure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("do")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("config"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("box "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"opentable/win-2012r2-standard-amd64-nocm"')]),e._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("communicator "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"winrm"')]),e._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("network "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"forwarded_port"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("33389")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" guest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3389")]),e._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("windows"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("set_work_network "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n  config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("vm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("provider "),a("span",{pre:!0,attrs:{class:"token symbol"}},[e._v(":virtualbox")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("do")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("v"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"win_test"')]),e._v("\n    v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("cpus "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n    v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("memory "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2048")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("end")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("end")]),e._v("\n")])])]),a("p",[e._v("I then used Remmina as an RDP client to connect to localhost:33389 and ran the IRC tool in Windows.  I'll save anyone else trying to run this Windows box with vagrant some pain:")]),e._v(" "),a("ul",[a("li",[e._v("xfreerdp doesn't work with it.  No idea why.  Remmina works perfectly.")]),e._v(" "),a("li",[e._v("Username and password are both 'vagrant'.  This is helpfullly specified exactly nowhere.")]),e._v(" "),a("li",[e._v("Domain is blank")])]),e._v(" "),a("h2",{attrs:{id:"proxmox-setup-and-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#proxmox-setup-and-configuration"}},[e._v("#")]),e._v(" Proxmox Setup and Configuration")]),e._v(" "),a("h3",{attrs:{id:"installing-proxmox"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installing-proxmox"}},[e._v("#")]),e._v(" Installing Proxmox")]),e._v(" "),a("p",[e._v("Was straightforward, there's so many guides to this I wont repeat the info here.")]),e._v(" "),a("h3",{attrs:{id:"ssh-access"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-access"}},[e._v("#")]),e._v(" SSH Access")]),e._v(" "),a("p",[e._v("I created new SSH keys on all my workstations just for interacting with my home lab equiptment using")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("ssh-keygen -t rsa\n")])])]),a("p",[e._v("Once in the install was done and the server was running, I sent SSH public keys from all of my workstations to the Proxmox server with")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("ssh-copy-id -i ~/.ssh/"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("key"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" admin@"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("proxmox-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("h3",{attrs:{id:"fix-proxmox-unlicensed-warning"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fix-proxmox-unlicensed-warning"}},[e._v("#")]),e._v(" Fix Proxmox Unlicensed Warning")]),e._v(" "),a("p",[e._v("Proxmox is free software, but they sell support licenses for commercial versions.  If you don't have a license, an annoying warning pops up every time you sign into the web management interface.  This is simple enough to remove - edit /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js and change the following conditional")]),e._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!==")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Active'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n")])])]),a("p",[e._v("to")]),e._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n")])])]),a("h3",{attrs:{id:"fix-subscription-only-package-repo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fix-subscription-only-package-repo"}},[e._v("#")]),e._v(" Fix Subscription-Only Package Repo")]),e._v(" "),a("p",[e._v("By default, apt on proxmox is configured to use a proxmox package repository which is only available for instances with active subscriptions.  As mentioned above, I don't have the money or need for a license a personal home lab.  We need to remove the license-only repo and replace it an unlicensed repo.  When this isn't done it breaks the use of Anisble apt directives (since 'apt update' will fail when it gets a 401 error trying to access the repo).  "),a("a",{attrs:{href:"https://pve.proxmox.com/wiki/Package_Repositories",target:"_blank",rel:"noopener noreferrer"}},[e._v("Proxmox docs on the repositories"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("Remove the enterprise repo list")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("rm")]),e._v(" /etc/apt/sources.list.d/pve-enterprise.list\n")])])]),a("p",[e._v("and then add the no subscription repository to /etc/apt/sources.list so it looks like this:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("deb http://ftp.debian.org/debian buster main contrib\ndeb http://ftp.debian.org/debian buster-updates main contrib\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# PVE pve-no-subscription repository provided by proxmox.com,")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# NOT recommended for production use")]),e._v("\ndeb http://download.proxmox.com/debian/pve buster pve-no-subscription\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# security updates")]),e._v("\ndeb http://security.debian.org/debian-security buster/updates main contrib\n")])])]),a("p",[e._v("You should be able to run 'apt update' without errors now.")])])}),[],!1,null,null,null);t.default=r.exports}}]);