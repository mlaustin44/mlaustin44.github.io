(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{370:function(t,e,s){t.exports=s.p+"assets/img/proxmoxbridge.b0a13d74.png"},390:function(t,e,s){"use strict";s.r(e);var a=s(10),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),a("p",[t._v("One of the main things I wanted to be able to use my home server for was self hosting applications.  Since Kubernetes has become the standard framework for enterprise container orchestration, and I use it frequently in projects at work, I thought that the home server was a great oppurtunity to leverage Kubernetes as my container orchestration framework while getting to learn more about its inner workings and management by deploying my own cluster.")]),t._v(" "),a("p",[t._v("I also wanted to use an automation technology to deploy everything on my home server using an 'infrastructure as code' solution.  This would accomplish 2 things for me: I'd get to learn a new technology of interest to me, and I'd have all of the steps to deploy and configure my home server captured as source-controlled code so that when I had to come fix something after not touching it for months I'd be able to quickly see how it had been configured and deployed")]),t._v(" "),a("p",[t._v("All of my commited code to build these VMs is on "),a("a",{attrs:{href:"https://github.com/mlaustin44/server_setup/tree/master/k8s-debian",target:"_blank",rel:"noopener noreferrer"}},[t._v("my Github"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("I think this will part 1 of a 5 part series on my home lab Kubernetes cluster:")]),t._v(" "),a("ol",[a("li",[t._v("Deploying VMs")]),t._v(" "),a("li",[t._v("Installing base software and configs")]),t._v(" "),a("li",[t._v("Bootstrapping a kubernetes cluster")]),t._v(" "),a("li",[t._v("Configuring MetalLB for load balancing")]),t._v(" "),a("li",[t._v("Configuring ingress-nginx for ingress routing")])]),t._v(" "),a("h2",{attrs:{id:"basic-plan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-plan"}},[t._v("#")]),t._v(" Basic Plan")]),t._v(" "),a("p",[t._v("I'm going to run a 4 node cluster (1 master, 3 workers) as Debian VMs on my "),a("RouterLink",{attrs:{to:"/_posts/2020-08-04-hp-proliant-dl360p-gen8-home-server.html"}},[t._v("Proxmox host server")]),t._v(".  My original plan was to use Fedora CoreOS, which is a stripped down container-only Linux OS which was bought by Red Hat recently.  I spent quite a bit of time getting a CoreOS deployment working but I eventually got stuck on getting the VMs to configure correctly on first boot using the unique Ignition tool that CoreOS uses instead of cloud-init.  I decided to shelve that plan as I didn't actually need CoreOS for anything - I just thought it would be a lightweight, interesting base for my cluster.  The most recent versions of my attempts is "),a("a",{attrs:{href:"https://github.com/mlaustin44/server_setup/tree/master/k8s-coreos",target:"_blank",rel:"noopener noreferrer"}},[t._v("commited to my github"),a("OutboundLink")],1),t._v(" in case anyone is curious.")],1),t._v(" "),a("p",[t._v("The Kubernetes cluster is going to run on a seperate VLAN from my main network (main is 192.168.1.0/24, k8s will be on 192.168.40.0/24).")]),t._v(" "),a("h2",{attrs:{id:"ansible-intro"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ansible-intro"}},[t._v("#")]),t._v(" Ansible Intro")]),t._v(" "),a("p",[t._v("Ansible is a great tool for automating setup and configuration tasks - basically anything that you could do through shell commands or scripts, Ansible has a much cleaner easier syntax configured with YAML files.  I'm certain I'm not using Ansible to the full extent of what it's capable of, but I'll try to teach what I learned as I go through my process in the hope that it offers a good intro to someone.")]),t._v(" "),a("p",[t._v("Ansible works by using a series of tasks which combine into a playbook.  Each task is a single action which needs to be taken, expressed in YAML form.  Each set of tasks can be applied to local or remote computers.")]),t._v(" "),a("h2",{attrs:{id:"network-pre-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#network-pre-configuration"}},[t._v("#")]),t._v(" Network Pre-Configuration")]),t._v(" "),a("p",[t._v("My server has a 4 port NIC, so I connected a second port to my switch.  That allows one port which is primary used for management traffic with no VLAN tagging, and one used for VMs which allows VLAN tagging.  I just created a second bridge adapter in Proxmox and made sure that 'VLAN Aware' was active:\n"),a("img",{attrs:{src:s(370),alt:"New Network Bridge"}})]),t._v(" "),a("p",[t._v("This way, any VM ethernet adapters configued to use VLAN tagging will have the 802.1q tags applied at the Proxmox bridge.")]),t._v(" "),a("p",[t._v("I also configured my router and switch to recognize the new VLAN and allow traffic on the switch port the second server interface as attached to.")]),t._v(" "),a("h2",{attrs:{id:"building-vms"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#building-vms"}},[t._v("#")]),t._v(" Building VMs")]),t._v(" "),a("h3",{attrs:{id:"configuring-ansible-inventory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuring-ansible-inventory"}},[t._v("#")]),t._v(" Configuring Ansible Inventory")]),t._v(" "),a("p",[t._v("Ansible uses an 'inventory.ini' file to tell it which computers to execute various tasks on.  Since I know what my final setup is going to look like with static IPs, I generated a new SSH key to use just for my VMs and then configured this Ansible inventory:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("proxmox_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n192.168.1.240\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s_master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n192.168.40.10\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s_nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n192.168.40.100\n192.168.40.101\n192.168.40.102\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("proxmox_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("vars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nansible_user='root'\nansible_shh_private_key_file='~/.ssh/server_key'\nansible_ssh_common_args='"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o ServerAliveInterval=5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o StrictHostKeyChecking=no'\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s_master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("vars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nansible_user='debian'\nansible_shh_private_key_file='~/.ssh/server_key'\nansible_ssh_common_args='"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o ServerAliveInterval=5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o StrictHostKeyChecking=no'\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k8s_nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("vars"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nansible_user='debian'\nansible_shh_private_key_file='~/.ssh/server_key'\nansible_ssh_common_args='"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o ServerAliveInterval=5 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o StrictHostKeyChecking=no'\n")])])]),a("p",[t._v("This configures three groups of hosts - one for my proxmox server, one for my k8s master node, and one for the remaining k8s worker nodes.  These groups are what can be targeted by tasks.")]),t._v(" "),a("p",[t._v("Since these are all remote machines that need to be SSH'd to, I also configured the user accounts, SSH keys, and SSH parameters for each connection.")]),t._v(" "),a("h3",{attrs:{id:"basic-setup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-setup"}},[t._v("#")]),t._v(" Basic Setup")]),t._v(" "),a("p",[t._v("Then I created a new .yml file for a playbook to deploy the VMs with a basic configuiration.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" proxmox_server\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gather_facts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vars")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vmstorage"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4010"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stormfather"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8192'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.40.10'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40100"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"windrunner"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4096'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.40.100'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40101"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lightweaver"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4096'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.40.101'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40102"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"edgedancer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4096'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.40.102'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("net_bridge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" vmbr1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("net_gw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.40.1"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("net_dns")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.1.1"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vlan_tag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("\n")])])]),a("p",[t._v("To break this down:")]),t._v(" "),a("ul",[a("li",[t._v("The hosts field tells ansible which group of hosts (from the inventory) this will be run on.  Since I'm going to be creating and configuring VMs, Ansible needs to run directly on the Proxmox server.")]),t._v(" "),a("li",[t._v("Gather_facts sets whether Ansible should run a report on the remote systems first.  It can get a huge amount of information about the remote systems, but since I didn't need any of that, it's disabled")]),t._v(" "),a("li",[t._v("The vars section lets you define variables which can be used in the playbook tasks.  I used this to store a list of the VMs I'm going to provision along with some basic individual configurations, as well as the overall networking configuration.")])]),t._v(" "),a("h3",{attrs:{id:"create-the-proxmox-resource-pool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-proxmox-resource-pool"}},[t._v("#")]),t._v(" Create the Proxmox resource pool")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Create resource pool for k8s VMs\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pvesh create /pools "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('poolid "kubernetes"\n  '),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ignore_errors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yes\n")])])]),a("p",[t._v("The first task is creating a Proxmox resource pool to group the VMs.  The Ansible 'shell' module just runs whatever follows as a shell command.  I set ignore_errors because during the development of these scripts I redeployed the VMs frequently without deleting the resource pool in between each run, so I needed Ansible to ignore the error the the resource pool already existed.")]),t._v(" "),a("h3",{attrs:{id:"download-the-debian-vm-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#download-the-debian-vm-image"}},[t._v("#")]),t._v(" Download the Debian VM image")]),t._v(" "),a("p",[t._v("Since I'm using QEMU KVM VMs for the nodes, I wanted to use a qcow2 image, which is a preinstalled, preconfigured VM disk image for running in a KVM.  This avoids needing to automate any installation or setup tasks and lets the VMs start with very basic installed and configured Debian.")]),t._v(" "),a("p",[t._v("Download the qcow2 image from Debian's openstack server:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Download Ubuntu Server 20.04 kvm image\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("get_url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//cdimage.debian.org/cdimage/openstack/current"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("10/debian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openstack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.qcow2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /tmp/debian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openstack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.qcow2\n")])])]),a("p",[t._v("Get_url just does a basic HTTP download like wget.  This is working remotely on the Proxmox server, so it's downloading that /tmp/ directory, not my local computer.")]),t._v(" "),a("h3",{attrs:{id:"copy-local-ssh-key-to-the-proxmox-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#copy-local-ssh-key-to-the-proxmox-server"}},[t._v("#")]),t._v(" Copy local SSH key to the Proxmox server")]),t._v(" "),a("p",[t._v("Need to get my SSH key on to the Proxmox server in order to configure the Kubernetes nodes with it.  By default, the Debian qcow2 image (like most qcow2 images for Linux distros) has a single user account with no password configured, so there's no way to SSH into the VM without configuring an SSH key, which we'll do later via cloud init.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Copy SSH key to proxmox server\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /home/mlaustin/.ssh/server_key.pub\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /tmp/key.pub\n")])])]),a("p",[t._v("Copy, by contrast, copies files from your local machine to the remote machine by default.  If you want it to copy within the remote machine, you need to use 'remote_src: true'.")]),t._v(" "),a("h3",{attrs:{id:"create-the-vms"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-the-vms"}},[t._v("#")]),t._v(" Create the VMs")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Create the k8s vms\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n    qm create {{ item.id }}\n    --pool kubernetes\n    --ostype l26\n    --name {{ item.name }}\n    --description "Kubernetes Node VM"\n    --agent 1\n    --cores {{ item.cpu }}\n    --memory {{ item.mem }}\n    --net0 virtio,bridge={{ net_bridge }},tag={{ vlan_tag }}\n    --ipconfig0 gw={{ net_gw }},ip={{ item.ip }}/24\n    --sshkeys /tmp/key.pub')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n")])])]),a("p",[t._v("There's quite a few things going on in this one.  'qm create' is the "),a("a",{attrs:{href:"https://pve.proxmox.com/pve-docs/qm.1.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Proxmox command to create a new qEMU virtual machine"),a("OutboundLink")],1),t._v(".  I'm going to break this into Ansible specific stuff about the task and Proxmox specific stuff about the shell command.")]),t._v(" "),a("h4",{attrs:{id:"the-ansible-stuff"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-ansible-stuff"}},[t._v("#")]),t._v(" The Ansible Stuff")]),t._v(" "),a("p",[t._v("Ansible uses the handlebar ( {{}} ) syntax for templating variables into text.  Anywhere a value appears surrounded by double curly brackets, Ansible with substitute in a variable.  It's convention to include a leading and trailing space around the contents of the bracketed variable.  You don't need qoutes or anything with the templating syntax - UNLESS you use it immediately following a YAML colon, in which case you need to use qoutes to show that you are using an Ansible string template, rather than a YAML object.")]),t._v(" "),a("p",[t._v("There are two ways to multi-line shell commands in Ansible - '|' and '>'.")]),t._v(" "),a("ul",[a("li",[t._v("'>' means that all the lines are combined into one before running.  It's equivilant to this in a shell script:"),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("qm create "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4010")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--pool kubernetes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--ostype l26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("\n")])])])]),t._v(" "),a("li",[t._v("'|' runs each line as a seperate command.  Generally in Ansible you dont want to combine too many things in one task because your visibility into results and errors is decreased because too many things are happening, but occasionally it makes more sense to combine dependent tasks.  The following commands are equivilant between Ansible and Bash:\n"),a("h5",{attrs:{id:"ansible"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ansible"}},[t._v("#")]),t._v(" Ansible")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n  apt-get update\n  apt-get install vim")]),t._v("\n")])])]),a("h5",{attrs:{id:"bash"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bash"}},[t._v("#")]),t._v(" Bash")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v("\n")])])])])]),t._v(" "),a("p",[t._v("'with_items' is the Ansible directive to loop over a list.  It's equivilant to "),a("code",[t._v("for item in items:")]),t._v(" in Python or "),a("code",[t._v("for (auto & item : vector) {...}")]),t._v(" in C++.  The variable name used inside the loop is 'item', and access to fields within the object are 'item.field'.  So this loop will run 4 times - once per item in the nodes list created in the configuration.  Recall the we need the qoutes around the template!  We want to pass in a raw list here, as with_items can also be used like:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" first_item\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" second_item\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" third_item\n")])])]),a("h4",{attrs:{id:"the-proxmox-stuff"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-proxmox-stuff"}},[t._v("#")]),t._v(" The Proxmox Stuff")]),t._v(" "),a("p",[t._v("Each time the loop runs, we'll run 'qm create' to create one virtual machine in Proxmox.  This will be a partially configured virtual machine at this step.")]),t._v(" "),a("p",[t._v("For any configuration that is occuring "),a("em",[t._v("within")]),t._v(" the VM (networking config, SSH keys, etc) Proxmox uses "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[t._v("cloud-init"),a("OutboundLink")],1),t._v(", which packages the configuration for the VM to consume into files and mounts them to the VM as a drive on first boot.  The qcow2 Debian image we are using is configured to automatically look for and use cloud init, so the values configured in the following commands are picked up by the VM at first boot and used to set the configuration.")]),t._v(" "),a("p",[t._v("Some of the arguments used to create the VM are pretty self explanatory, while others are more involved. I'll just cover the involved ones here:")]),t._v(" "),a("ul",[a("li",[t._v("ostype: the type of guest operating system.  These are described in the "),a("a",{attrs:{href:"https://pve.proxmox.com/wiki/Qemu/KVM_Virtual_Machines",target:"_blank",rel:"noopener noreferrer"}},[t._v("Proxmox manual"),a("OutboundLink")],1),t._v(" (search for 'ostype: <' to find the section).  l26 means a Linux guest, Kernel version >2.6.")]),t._v(" "),a("li",[t._v("agent: whether the "),a("a",{attrs:{href:"https://pve.proxmox.com/wiki/Qemu-guest-agent",target:"_blank",rel:"noopener noreferrer"}},[t._v("Qemu guest agent"),a("OutboundLink")],1),t._v(" is enabled.  The guest agent is a daemon that gets installed inside the guest to allow the host to pass in ACPI commands to reset, power off, etc.")]),t._v(" "),a("li",[t._v("net0: the 0 means this is the first network device (eth0 on Linux).  You can configure as many network devices as the guest would support using --net1, --net2...--netN.  The value of this command configures the "),a("em",[t._v("hardware")]),t._v(" portion of the network device, while the --ipconfig argument configures the "),a("em",[t._v("networking")]),t._v(" configuration of the network device.  The values passed into the network adpater config must be comma seperated without spaces.\n"),a("ul",[a("li",[t._v("The first argument is the device type to attach.  Qemu is capable of emulating a variety of real-world physical network interface devices, but emulation of hardware adds extra overhead the virtualization.  "),a("a",{attrs:{href:"https://wiki.libvirt.org/page/Virtio",target:"_blank",rel:"noopener noreferrer"}},[t._v("virtio"),a("OutboundLink")],1),t._v(" is a set of standardized virtualization native device drivers which are included in most major operating systems.  This allows the host to use a very efficent interface for devices without needing to worry about driver compatibility.  Debian (like every major linux distro) has virtio drivers included, so we'll use the virtual device instead of trying to emulate a hardware device.")]),t._v(" "),a("li",[t._v("Bridge allows us to specify which bridge adpater the machine should be connected to.  Recall that hypervisor VM bridges are software network switches, so this is just selecting which switch we are plugging our VM into.")]),t._v(" "),a("li",[t._v("Tag sets the 802.1q VLAN tagging.  This argument is only needed if the VMs will be running on a VLAN, otherwise it can be removed.")]),t._v(" "),a("li",[t._v("There are a variety of additional values which can be configured, see the Proxmox documentation for details (search 'net[n]:' on "),a("a",{attrs:{href:"https://pve.proxmox.com/wiki/Qemu/KVM_Virtual_Machines",target:"_blank",rel:"noopener noreferrer"}},[t._v("this page"),a("OutboundLink")],1),t._v(")")])])]),t._v(" "),a("li",[t._v("ipconfig0: sets the IP configuration for a network adapter with the matching number (net0<->ipconfig0, etc).  This configuration is passed into the VM as described above.  You can pass the string 'dhcp' to use DHCP, otherwise an IP address (with CIDR) and gateway need to be provided.")]),t._v(" "),a("li",[t._v("sshkeys: location of the public key file for the SSH key to be used.  One important note - you can only pass in a single --sshkeys argument.  I ran into trouble trying to configure multiple SSH keys at the same time as only the last key provided would take.  The documentation says 'one key per line, OpenSSH format'.  It doesn't mean to pass multiple lines to the command, but rather to pass in a file with multiple SSH keys in it, one per line, like an authorized_hosts file.  In my case, I just pass in the key file which was copied to the Proxmox host in an earlier step.")])]),t._v(" "),a("h3",{attrs:{id:"import-the-debian-disk-to-each-vm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#import-the-debian-disk-to-each-vm"}},[t._v("#")]),t._v(" Import the Debian disk to each VM")]),t._v(" "),a("p",[t._v("As mentioned above, the qcow2 disk images are virtual hard drives ready to restore on to a VM.  In Proxmox 'qm importdisk' does exactly what it says:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Import qcow2 image as a disk to each VM\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qm importdisk "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item.id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" /tmp/debian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openstack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("amd64.qcow2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" stg "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n")])])]),a("p",[t._v("This step takes a while as each compressed qcow2 image needs to be expanded to its original size.")]),t._v(" "),a("h3",{attrs:{id:"configure-the-imported-disks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-the-imported-disks"}},[t._v("#")]),t._v(" Configure the imported disks")]),t._v(" "),a("p",[t._v("The disks are now imported to the VMs, but they're not configured to actually mount to them.  We can now go back to the VMs and configure some remaining hardware using 'qm set', which is a general tool that edits any attribute of a VM.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Configure the VM disk hardware\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n    qm set {{ item.id }}\n    --scsihw virtio-scsi-pci\n    --scsi0 {{ stg }}:vm-{{ item.id }}-disk-0\n    --ide2 "{{ stg }}:cloudinit"\n    --serial0 /dev/tty0\n    --boot c\n    --bootdisk scsi0')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n")])])]),a("p",[t._v("Quick run through these arguments:")]),t._v(" "),a("ul",[a("li",[t._v("scsihw: sets the model of the SCSI controller configured on the VM.  As always, I'm going with the virtio device where possible and configuring it as a PCI card SCSI adapter")]),t._v(" "),a("li",[t._v("scsi0: this sets the disk to attach to the VM as the first (well, zero-th) hard drive.  When I ran 'qm importdisk' in the prior step it imported the disk and named it according to a standard scheme which we use to attach it to the VM here.")]),t._v(" "),a("li",[t._v("ide2: mounts the cloud-init disk as a CD drive on the VM so it can adopt the configuration.  The use of n=2 and the disk name are both "),a("a",{attrs:{href:"https://pve.proxmox.com/wiki/Cloud-Init_Support",target:"_blank",rel:"noopener noreferrer"}},[t._v("standard in Proxmox"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("serial0: creates a serial device on the VM and configures a passthrough to the host at the specified /dev/tty.  This is also required for cloud-init and is configured per the Proxmox documentation and is required by Openstack images for "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/topics/datasources/smartos.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("SmartOS Datasource"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("boot: sets the boot device, where a=floppy, c=HDD, d=CD-ROM, and n=network")]),t._v(" "),a("li",[t._v("bootdisk: sets the disk to boot from")])]),t._v(" "),a("h3",{attrs:{id:"resize-the-hard-disks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#resize-the-hard-disks"}},[t._v("#")]),t._v(" Resize the hard disks")]),t._v(" "),a("p",[t._v("The qcow2 images had a configured size prior to compression which they will revert to when they're imported.  I want to resize them to 20gb, which can be done with the 'qm resize' command:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Resize VM disks\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qm resize "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item.id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" scsi0 20G\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n")])])]),a("h3",{attrs:{id:"finally-start-the-vms-and-wait-for-them-to-be-available"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#finally-start-the-vms-and-wait-for-them-to-be-available"}},[t._v("#")]),t._v(" Finally, start the VMs and wait for them to be available")]),t._v(" "),a("p",[t._v("Pretty straightfoward - Ansible has a wait_for directive which allows you to set a hostname and port and wait until that host is responding on that port.  The default timeout is 300 seconds (5 minutes):")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Start the VMs\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qm start "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item.id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Wait for VMs to be available\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("wait_for")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ item.ip }}"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VMs not available after 5 minutes"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ nodes }}"')]),t._v("\n")])])]),a("h2",{attrs:{id:"run-the-playbook"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-the-playbook"}},[t._v("#")]),t._v(" Run the playbook")]),t._v(" "),a("p",[t._v("I ran the Ansible playbook with:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("ansible-playbook -i inventory.ini playbooks/deploy_vms.yml\n")])])]),a("p",[t._v("In order to simplify my workflow once I had more than one playbook to run (since I tried to seperate logical steps into seperate playbooks), I created a site.yml file which automated calling a series of playbooks:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/deploy_vms.yml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/install_base_software.yml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/bootstrap_k8s.yml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/deploy_metallb.yml\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("import_playbook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" playbooks/deploy_nginx_ingress.yml\n")])])]),a("p",[t._v("I also made myself a handy little counterpart playbook called 'destroy_vms.yml' to clean up my inevitable mistakes before trying again:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" proxmox_server\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gather_facts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("False")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vars")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("id_list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4010"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40100"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40101"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"40102"')]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tasks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Forcibly remove the locks\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rm "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f /var/lock/qemu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server/lock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(".conf\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ id_list }}"')]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Stop VMs\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qm stop "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ id_list }}"')]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Destroy VMs\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qm destroy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("purge\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ id_list }}"')]),t._v("\n")])])]),a("p",[t._v("My standard command during development was to run:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("ansible-playbook -i inventory.ini playbooks/destroy_vms.yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" ansible-playbook -i inventory.ini site.yml\n")])])]),a("p",[t._v("...and then take a quick 5 minute break.")]),t._v(" "),a("h2",{attrs:{id:"next-time"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#next-time"}},[t._v("#")]),t._v(" Next Time")]),t._v(" "),a("p",[t._v("We install some software on the VMs!")]),t._v(" "),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),a("ol",[a("li",[t._v("https://github.com/zimmertr/Bootstrap-Kubernetes-with-QEMU")])])])}),[],!1,null,null,null);e.default=n.exports}}]);